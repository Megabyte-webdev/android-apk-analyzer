// middleware/malwareScanner.js
import { exec } from "child_process";

const malwareScanner = (req, res, next) => {
  const apkPath = req.file?.path;
  if (!apkPath)
    return res
      .status(400)
      .json({ success: false, error: "No file uploaded for scan." });

  // Use ClamAV or other tools
  exec(`clamscan ${apkPath}`, (err, stdout, stderr) => {
    if (err && err.code !== 1) {
      // Code 1 means virus found
      return res
        .status(500)
        .json({ success: false, error: "Malware scan failed." });
    }

    if (stdout.includes("Infected files: 1")) {
      return res.status(403).json({
        success: false,
        error: "Malware detected in APK. Upload blocked.",
      });
    }

    next();
  });
};

export default malwareScanner;
